<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Anwar's Arcade - The Ultimate Mobile Hub">
    <meta name="theme-color" content="#1e293b">
    <title>ANWARSARCADE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'base-dark': '#0f172a',
                        'accent': '#6366f1',
                        'accent-hover': '#4f46e5',
                        'panic': '#f87171', 
                        'warn': '#fbbf24', 
                        'success': '#34d399',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    animation: {
                        'gradient-x': 'gradient-x 20s ease infinite',
                        'glow-pulse': 'glow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        'gradient-x': {
                            '0%, 100%': { 'background-size': '200% 200%', 'background-position': 'left center' },
                            '50%': { 'background-size': '200% 200%', 'background-position': 'right center' },
                        },
                        'glow': {
                            '0%, 100%': { 'box-shadow': '0 0 8px rgba(99, 102, 241, 0.4)' },
                            '50%': { 'box-shadow': '0 0 16px rgba(99, 102, 241, 0.8)' },
                        },
                        'fadeIn': {
                             '0%': { opacity: 0 },
                             '100%': { opacity: 1 },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* --- CORE VISUALS --- */
        
        /* PERFORMANCE MODE (Potato Mode) - No animations, flat colors */
        body.perf-mode {
            background: #111827 !important;
            animation: none !important;
        }
        body.perf-mode .glass-panel {
            background: #1e293b !important;
            backdrop-filter: none !important;
            box-shadow: none !important;
            border: 1px solid #334155 !important;
        }
        body.perf-mode * {
            animation: none !important;
            transition: none !important;
        }

        /* Default High Quality Mode */
        body[data-theme="dark"]:not(.perf-mode) {
            background: linear-gradient(-45deg, #0f172a, #1e293b, #334155, #0f172a);
            background-size: 400% 400%;
            animation: gradient-x 20s ease infinite;
            color: #e2e8f0;
        }
        body[data-theme="light"]:not(.perf-mode) {
            background: linear-gradient(-45deg, #e2e8f0, #f8fafc, #cbd5e1, #e2e8f0);
            background-size: 400% 400%;
            animation: gradient-x 20s ease infinite;
            color: #1e293b;
        }

        /* Glass Panels */
        .glass-panel {
            transition: background 0.3s, border-color 0.3s, box-shadow 0.3s;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        body[data-theme="dark"] .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        body[data-theme="light"] .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* --- UI CONTAINER ROUNDING FIX (APPLIED ROUNDED-2XL) --- */
        /* Base Dark UI Element (used for perf mode toggle, etc.) */
        .ui-bg { 
            /* Changing from rounded-xl to rounded-2xl for more round corners */
            @apply bg-white/5 border border-white/10 rounded-2xl; 
        }
        body[data-theme="light"] .ui-bg { 
            @apply bg-white border-slate-300; 
        }

        /* Overrides for specific Inputs (Panic/Search/Game Boxes) to make them look DARKER */
        /* Applying rounded-2xl to the element definition, which affects all inputs using ui-bg */
        #panic-url, #panic-title, #desktop-search, 
        .ui-bg input[type="text"], .ui-bg input[type="url"], 
        #game-selector, #override-url {
            /* Input color/background styling */
            background-color: rgba(0, 0, 0, 0.4); 
            border-color: rgba(255, 255, 255, 0.2); 
            color: #f8fafc;
            /* Explicitly applying rounding class for all wide inputs */
            @apply rounded-2xl;
        }
        
        /* Ensure the input text color is visible everywhere */
        #settings-modal input[type="text"], 
        #settings-modal input[type="url"], 
        #settings-modal select {
            color: #f8fafc; 
        }

        /* Placeholder contrast fix (brighter placeholder text) */
        #settings-modal input::placeholder {
            color: #cbd5e1; 
        }


        /* --- CARD ROUNDING FIX (Game Cards Fix) --- */
        .game-card-rounded {
            @apply rounded-2xl; /* This remains the same high rounding for the game grid */
        }
        
        /* --- CARD TEXT COLOR FIX (Game Card Text Fix) --- */
        .game-card-text {
            color: #1e293b; /* Dark slate (Ensures contrast against bright card image) */
        }
        .game-card-text-accent {
            color: #4f46e5; /* Darker accent purple */
        }
        .game-card-button {
             background: rgba(0, 0, 0, 0.3); 
        }


        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }

        /* Filter Pills */
        .filter-pill {
            @apply px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all border border-transparent opacity-70 hover:opacity-100 hover:scale-105;
            background: rgba(128,128,128, 0.1);
        }
        .filter-pill.active {
            @apply opacity-100 bg-accent text-white shadow-lg shadow-accent/40;
        }

        /* Arcade Buttons */
        .arcade-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: 4px solid rgba(255, 255, 255, 0.15); 
            color: white;
            border-radius: 50%;
            transition: all 0.05s ease-out;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            touch-action: none; 
        }
        .arcade-btn:active, .arcade-btn.pressed {
            transform: translateY(4px); 
            border-bottom: 0px solid transparent; 
            background: #6366f199;
        }

        .tab-btn {
            /* Ensuring tab buttons also look more rounded */
            @apply px-4 py-2 text-sm font-semibold rounded-2xl transition-colors border-2 border-transparent text-gray-400 hover:text-white hover:bg-accent/10;
        }
        .tab-btn.active {
            @apply text-accent border-accent bg-accent/20;
        }

        #game-view { background-color: #0f172a; }
    </style>
</head>
<body data-theme="dark" class="font-sans min-h-screen flex flex-col h-screen overflow-hidden">

    <div id="overlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm transition-opacity duration-300">
        <div id="overlay-content" class="p-8 rounded-2xl max-w-sm text-center"></div>
    </div>
    <div id="toast-container" class="fixed top-20 right-5 z-[101] flex flex-col gap-2 pointer-events-none"></div>

    <header class="glass-panel sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center p-3 md:p-4">
            <div class="flex items-center gap-3 cursor-pointer group select-none" onclick="goHome()">
                <div class="bg-accent/20 p-2 rounded-2xl border border-accent/30 group-hover:rotate-12 transition-transform">
                    <i class="ph-fill ph-game-controller text-2xl text-accent"></i>
                </div>
                <h1 class="text-xl md:text-2xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-white via-gray-200 to-gray-400">
                    ANWARSARCADE
                </h1>
            </div>

            <div class="flex items-center gap-3">
                <div class="relative hidden md:block w-56 lg:w-72">
                    <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 opacity-50"></i>
                    <input type="text" id="desktop-search" placeholder="Find game..." class="w-full ui-bg py-2 pl-10 pr-4 text-sm focus:border-accent outline-none transition" oninput="filterGames(this.value)">
                </div>

                <button id="mode-toggle-btn" onclick="toggleCloak()" class="px-3 py-1.5 bg-accent/10 border border-accent/20 rounded-full text-xs font-bold uppercase tracking-wide transition flex items-center gap-2">
                    <i id="mode-icon" class="ph-fill ph-eye"></i>
                    <span id="mode-text">Cloak</span>
                </button>
                
                <button onclick="openSettings()" class="p-2 ui-bg rounded-full hover:bg-white/10 transition"><i class="ph-fill ph-gear text-xl"></i></button>
            </div>
        </div>
        
        <div class="md:hidden px-3 pb-3 border-b border-white/5">
             <input type="text" placeholder="Search games..." class="w-full ui-bg p-2 text-sm focus:border-accent outline-none" oninput="filterGames(this.value)">
        </div>
    </header>

    <main id="main-content" class="flex-grow relative w-full h-full overflow-hidden">
        
        <div id="grid-view" class="w-full h-full overflow-y-auto custom-scroll p-4 pb-20 md:p-8">
            <div class="max-w-7xl mx-auto space-y-8">
                
                <div class="flex gap-2 overflow-x-auto pb-2 custom-scroll" id="category-filters">
                    </div>

                <div id="recent-section" class="hidden animate-fade-in">
                    <h2 class="text-xs font-bold uppercase tracking-widest text-accent mb-3 flex items-center gap-2">
                        <i class="ph-bold ph-clock-counter-clockwise"></i> Recently Played
                    </h2>
                    <div id="recent-grid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                    <div class="h-px bg-white/5 w-full mt-6"></div>
                </div>

                <div id="favorites-section" class="hidden animate-fade-in">
                    <h2 class="text-xs font-bold uppercase tracking-widest text-panic mb-3 flex items-center gap-2">
                        <i class="ph-fill ph-heart"></i> Favorites
                    </h2>
                    <div id="favorites-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5"></div>
                    <div class="h-px bg-white/5 w-full mt-6"></div>
                </div>

                <div>
                    <div class="flex justify-between items-end mb-4">
                        <h2 class="text-2xl font-bold tracking-tight">Library</h2>
                        <span id="game-count" class="text-xs font-mono opacity-50 bg-white/5 px-2 py-1 rounded-2xl">0 Games</span>
                    </div>
                    <div id="games-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5"></div>
                </div>
            </div>
        </div>

        <div id="game-view" class="hidden absolute inset-0 z-40 flex flex-col w-full h-full">
            
            <div id="game-toolbar" class="h-14 shrink-0 flex items-center justify-between px-4 bg-black/80 border-b border-white/10 backdrop-blur-sm z-50">
                <button class="flex items-center gap-2 text-sm font-bold text-gray-400 hover:text-white transition" onclick="goHome()">
                    <i class="ph-bold ph-arrow-left"></i> <span class="hidden sm:inline">Exit</span>
                </button>
                
                <div class="flex items-center gap-4">
                    <div class="hidden md:flex items-center gap-2 px-3 py-1 rounded-2xl bg-white/5 border border-white/10">
                        <i class="ph-bold ph-timer text-accent"></i>
                        <span id="session-timer" class="font-mono text-xs">00:00</span>
                    </div>
                    <h2 id="current-game-title" class="text-sm font-bold text-gray-300 truncate max-w-[150px]">Playing</h2>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="refreshGame()" class="p-1.5 rounded-full text-success hover:bg-success/10" title="Refresh Frame">
                         <i class="ph-fill ph-arrow-clockwise text-xl"></i>
                    </button>
                    <button onclick="restartGame()" class="p-1.5 rounded-full text-warn hover:bg-warn/10" title="Restart Session">
                         <i class="ph-fill ph-fast-forward text-xl"></i>
                    </button>
                    <button onclick="toggleRefocusButton()" class="p-1.5 rounded-full text-gray-400 hover:bg-white/10" title="Toggle Focus Helper">
                         <i id="refocus-toggle-icon" class="ph-fill ph-target-bold text-xl"></i>
                    </button>
                    <button onclick="toggleMobileControls()" class="text-gray-400 hover:text-white md:hidden" title="Controls">
                        <i class="ph-fill ph-game-controller text-xl"></i>
                    </button>
                    <div class="h-4 w-px bg-white/10"></div>
                    <button class="text-panic hover:text-red-400 transition" onclick="triggerPanic()" title="Panic">
                        <i class="ph-fill ph-warning-circle text-xl"></i>
                    </button>
                    <button class="text-gray-400 hover:text-white transition" onclick="toggleTrueFullscreen()" title="Fullscreen">
                        <i id="true-fullscreen-icon" class="ph-bold ph-arrows-out text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="relative flex-grow w-full h-full bg-black overflow-hidden">
                <div id="iframe-loader" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 z-20 hidden"></div>
                
                <div id="iframe-wrapper" class="w-full h-full z-10"></div>

                <div id="mobile-controls" class="absolute inset-0 z-50 pointer-events-none hidden select-none touch-none">
                    <div id="d-pad-container" class="absolute bottom-6 left-6 pointer-events-auto">
                        <div class="grid grid-cols-3 grid-rows-3 gap-2 w-[160px] h-[160px]">
                            <div></div><div class="arcade-btn w-full h-full" data-key="ArrowUp"><i class="ph-bold ph-caret-up text-xl"></i></div><div></div>
                            <div class="arcade-btn w-full h-full" data-key="ArrowLeft"><i class="ph-bold ph-caret-left text-xl"></i></div><div></div><div class="arcade-btn w-full h-full" data-key="ArrowRight"><i class="ph-bold ph-caret-right text-xl"></i></div>
                            <div></div><div class="arcade-btn w-full h-full" data-key="ArrowDown"><i class="ph-bold ph-caret-down text-xl"></i></div><div></div>
                        </div>
                    </div>
                    <div id="action-buttons-container" class="absolute bottom-8 right-6 pointer-events-auto">
                        <div class="flex flex-row-reverse items-end gap-6 transform rotate-[-15deg]">
                            <div class="arcade-btn w-20 h-20 bg-accent/20 border-accent/30 flex items-center justify-center" data-key=" "><span class="font-black text-xl">A</span></div>
                            <div class="arcade-btn w-16 h-16 bg-red-500/10 border-red-500/20 mb-6 flex items-center justify-center" data-key="Enter"><span class="font-black text-lg">B</span></div>
                        </div>
                    </div>
                </div>

                <button id="refocus-button" onclick="focusIframe()" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-accent/90 hover:bg-accent text-white p-4 rounded-2xl shadow-lg z-50 animate-glow-pulse">
                    <i class="ph-bold ph-cursor-text text-xl mr-2"></i> Click to Focus Game
                </button>
            </div>
        </div>
    </main>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-lg z-[60] flex items-center justify-center p-4" onclick="closeSettings(event)">
        <div class="glass-panel w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col h-full max-h-[90vh]" onclick="event.stopPropagation()">
            
            <header class="p-6 pb-4 border-b border-white/10">
                <h3 class="text-2xl font-bold text-accent mb-4">Arcade Settings</h3>
                <div class="flex flex-wrap gap-3">
                    <button class="tab-btn active" data-tab="general" onclick="switchSettingsTab('general')">General</button>
                    <button class="tab-btn" data-tab="cloak" onclick="switchSettingsTab('cloak')">Cloak Mode</button>
                    <button class="tab-btn" data-tab="game-specific" onclick="switchSettingsTab('game-specific')">Game Overrides</button>
                </div>
            </header>

            <div class="flex-grow overflow-y-auto custom-scroll p-6 space-y-6">
                
                <div id="tab-general" class="space-y-4">
                    <h4 class="text-lg font-semibold text-accent border-b border-accent/20 pb-2">Appearance & Performance</h4>
                    
                    <div class="flex items-center justify-between p-3 ui-bg">
                        <div>
                            <div class="font-bold text-sm">Performance ("Potato") Mode</div>
                            <div class="text-[10px] opacity-70">Disables animations/blur. Recommended for school Chromebooks.</div>
                        </div>
                        <input type="checkbox" id="perf-toggle" onchange="togglePerfMode(this.checked)" class="w-5 h-5 accent-accent">
                    </div>

                    <div class="flex items-center justify-between p-3 ui-bg">
                        <label class="text-sm font-semibold flex items-center gap-2"><i class="ph-fill ph-palette text-accent"></i> Theme</label>
                        <button onclick="toggleTheme()" class="px-3 py-1.5 rounded-2xl bg-accent hover:bg-accent-hover text-white text-xs font-bold transition">Switch Theme</button>
                    </div>

                    <h4 class="text-lg font-semibold text-accent border-b border-accent/20 pb-2 pt-4">Data Management</h4>
                    <div class="p-3 ui-bg flex justify-between items-center">
                        <div class="text-sm font-semibold">Clear Local Data</div>
                        <button onclick="clearLocalStorage()" class="px-3 py-1.5 bg-panic/20 hover:bg-panic/30 border border-panic/40 rounded-2xl text-panic text-xs font-bold transition">Reset Everything</button>
                    </div>
                </div>

                <div id="tab-cloak" class="space-y-4 hidden">
                    <h4 class="text-lg font-semibold text-accent border-b border-accent/20 pb-2">Panic Configuration</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold uppercase tracking-widest">Panic URL</label>
                            <input type="url" id="panic-url" class="mt-1 w-full ui-bg p-3 text-sm outline-none" placeholder="https://classroom.google.com">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold uppercase tracking-widest">Tab Title</label>
                            <input type="text" id="panic-title" class="mt-1 w-full ui-bg p-3 text-sm outline-none" placeholder="Classwork">
                        </div>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-accent border-b border-accent/20 pb-2 pt-4">Custom Favicon</h4>
                    <div class="ui-bg p-4 space-y-3">
                        <label class="text-[10px] font-bold uppercase tracking-widest">Upload Custom Icon (PNG/JPG)</label>
                        <input type="file" id="panic-icon-file" accept="image/png, image/jpeg, image/x-icon" onchange="previewIcon(event)" class="w-full text-sm text-gray-400
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-2xl file:border-0
                            file:text-sm file:font-semibold
                            file:bg-accent/20 file:text-accent
                            hover:file:bg-accent/30
                        ">
                        <div class="flex items-center gap-3">
                            <span class="text-xs opacity-70">Preview:</span>
                            <div id="panic-icon-preview" class="w-6 h-6 border border-white/20 rounded-2xl bg-cover bg-center"></div>
                            <button onclick="resetIcon()" class="text-xs text-panic hover:underline">Reset Icon</button>
                        </div>
                    </div>
                </div>

                <div id="tab-game-specific" class="space-y-4 hidden">
                    <h4 class="text-lg font-semibold text-accent border-b border-accent/20 pb-2">Advanced Game Fixes</h4>
                    <p class="text-xs opacity-70">If a game isn't loading or controls aren't working, fix it here.</p>

                    <select id="game-selector" onchange="loadGameSettings(this.value)" class="w-full ui-bg p-3 text-sm outline-none mb-4">
                        <option value="">--- Select a Game ---</option>
                    </select>

                    <div id="game-settings-panel" class="p-4 ui-bg space-y-4 hidden">
                        <div>
                            <label class="text-[10px] font-bold uppercase tracking-widest">URL Override</label>
                            <input type="url" id="override-url" class="mt-1 w-full ui-bg p-3 text-sm outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold uppercase tracking-widest mb-2 block">Permissions</label>
                            <div class="grid grid-cols-2 gap-3 text-xs">
                                <label class="flex gap-2"><input type="checkbox" id="sandbox-scripts" data-perm="allow-scripts" class="accent-accent"> allow-scripts</label>
                                <label class="flex gap-2"><input type="checkbox" id="sandbox-pointer" data-perm="allow-pointer-lock" class="accent-accent"> allow-pointer-lock</label>
                            </div>
                            <button onclick="fixGameControls()" class="mt-4 w-full py-2 bg-success/20 text-success font-bold rounded-2xl text-xs">Quick Fix: Enable Controls</button>
                        </div>
                        <div class="flex gap-4 pt-2">
                             <button onclick="saveGameOverrides()" class="flex-grow py-3 bg-accent hover:bg-accent-hover text-white font-bold rounded-2xl shadow-lg transition text-sm">Save Fixes</button>
                        </div>
                    </div>
                </div>

            </div>
            <footer class="p-4 border-t border-white/10">
                <button onclick="saveSettings()" class="w-full py-3 bg-accent hover:bg-accent-hover text-white font-bold rounded-2xl transition">Save Global Settings</button>
            </footer>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE (UPDATED GAME LIST: 18 GAMES) ---
        const gamesDB = [
            { id: 'mc', title: 'Minecraft Classic', tag: 'Sandbox', url: 'https://db.ducklit.com/html/minecraft/index.html', img: 'https://image2url.com/images/1765589406443-d8e0e31f-b637-4632-9b69-65978adc5111.jpg' },
            { id: 'retro', title: 'Retro Bowl', tag: 'Sports', url: 'https://db.ducklit.com/html/retro_bowl/index.html', img: 'https://image2url.com/images/1765589475090-207b5909-ca3f-400c-9876-6a453f4abda8.png' },
            { id: 'slope', title: 'Slope', tag: 'Arcade', url: 'https://db.ducklit.com/html/slope/index.html', img: 'https://image2url.com/images/1765589547050-218a37f6-2623-4974-9df8-d6878fa9dfc3.png' },
            { id: 'rooftop', title: 'Rooftop Snipers', tag: 'Action', url: 'https://db.ducklit.com/html/rooftop_snipers/index.html', img: 'https://image2url.com/images/1765589585417-2e757935-31f6-4b9b-ba65-586971069729.png' },
            { id: 'basket', title: 'Basket Random', tag: 'Sports', url: 'https://db.ducklit.com/html/basket_random/index.html', img: 'https://image2url.com/images/1765589697808-5d097a64-9de9-4c27-8a72-632404d6b4d2.png' },
            { id: 'drive', title: 'Drive Mad', tag: 'Driving', url: 'https://db.ducklit.com/html/drive_mad/index.html', img: 'https://image2url.com/images/1765589648114-148eb86c-f6b1-46c1-8d10-69248f3b6ccd.png' },
            { id: 'temple', title: 'Temple Run 2', tag: 'Runner', url: 'https://db.ducklit.com/html/temple_run_2/index.html', img: 'https://image2url.com/images/1765589772359-7a8e1504-5672-4024-ba37-633b84809096.png' },
            { id: 'crossy', title: 'Crossy Road', tag: 'Arcade', url: 'https://db.ducklit.com/html/crossy_road/index.html', img: 'https://image2url.com/images/1765589841042-ef890c5c-44d3-4b84-bee9-33ad710871ac.png' },
            { id: 'bitlife', title: 'BitLife', tag: 'Sim', url: 'https://db.ducklit.com/html/bitlife/index.html', img: 'https://image2url.com/images/1765589944044-43a2579d-384e-4ca9-87ff-db78490c2cb7.png' },
            { id: 'stickman', title: 'Stickman Hook', tag: 'Arcade', url: 'https://db.ducklit.com/html/stickman_hook/index.html', img: 'https://image2url.com/images/1765589983781-43d53063-f86a-4202-8e4d-7b582856e389.png' },
            { id: 'run3', title: 'Run 3', tag: 'Runner', url: 'https://db.ducklit.com/html/run3/index.html', img: 'https://image2url.com/images/1765590006092-1aad5d49-8ed7-43d2-8b93-97a6e42e03f7.png' },
            { id: 'hole', title: 'Hole.io', tag: 'Arcade', url: 'https://db.ducklit.com/html/holeio/index.html', img: 'https://image2url.com/images/1765590044759-a90a0527-798a-4b39-a343-88a6e7477c89.png' },
            { id: 'amongus', title: 'Among Us', tag: 'Puzzles', url: 'https://db.ducklit.com/html/among_us/index.html', img: 'https://image2url.com/images/1765590069675-b6a67bca-7cf2-4c25-a25a-1fd5fc3d218e.png' },
            { id: 'happy', title: 'Happy Wheels', tag: 'Physics', url: 'https://db.ducklit.com/html/happy_wheels/index.html', img: 'https://image2url.com/images/1765590115002-7eb4fcd2-497a-4dda-aee5-3d036c468b70.png' },
            { id: 'flappy', title: 'Flappy Bird', tag: 'Arcade', url: 'https://db.ducklit.com/html/flappy_bird/index.html', img: 'https://image2url.com/images/1765590147567-9450db83-7a1e-436e-b0ad-abc8c5ac67db.png' },
            { id: 'cookie', title: 'Cookie Clicker', tag: 'Idle', url: 'https://db.ducklit.com/html/cookie_clicker/index.html', img: 'https://image2url.com/images/1765590172498-ce974f7c-709f-4d22-b4d8-2d156c2a8038.png' },
            { id: '2048', title: '2048', tag: 'Puzzle', url: 'https://db.ducklit.com/html/2048/index.html', img: 'https://image2url.com/images/1765590203281-03f26bce-de3f-40e6-8518-afb8c29445a8.png' },
            { id: 'bloons', title: 'Bloons Tower Defense 5', tag: 'Strategy', url: 'https://db.ducklit.com/html/btd5/index.html', img: 'https://image2url.com/images/1765590262356-04c9bf39-c997-49bf-93aa-21c275021e01.png' },
            { id: 'basketball bros', title: 'Basketball Bros', tag: 'Sports', url: 'https://db.ducklit.com/html/basket_bros/index.html', img: 'https://image2url.com/images/1765590313352-c75906c3-c7e9-4760-acf6-a674ef08c176.png'},
            { id: 'moto3xm', title: 'Moto3xm', tag: 'Driving', url: 'https://db.ducklit.com/html/moto_x3m_3/index.html', img: 'https://image2url.com/images/1765590338734-ec769f89-68de-40b6-b4a1-eaa29dedd763.png'}
        ];

        
        const DEFAULT_ICON = "https://th.bing.com/th/id/OIG1.OAyEfLA4ZLv.MiIVyHYZ?cb=ucfimg2&pid=ImgGn&ucfimg=1"; // Default icon (empty string uses HTML default)
        const CLOAK_ICON_URL = "https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico"; // Default Google Docs icon

        let state = {
            favs: JSON.parse(localStorage.getItem('arcade_favs') || '[]'),
            recent: JSON.parse(localStorage.getItem('arcade_recent') || '[]'),
            overrides: JSON.parse(localStorage.getItem('arcade_overrides') || '{}'),
            panic: JSON.parse(localStorage.getItem('arcade_panic') || '{"url": "https://classroom.google.com", "title": "Classwork", "icon": ""}'),
            theme: localStorage.getItem('arcade_theme') || 'dark',
            perfMode: localStorage.getItem('arcade_perf') === 'true',
            isCloaked: false,
            activeGameId: null,
            timerInterval: null
        };

        const DEFAULT_SANDBOX = ["allow-scripts", "allow-same-origin", "allow-forms", "allow-pointer-lock"];

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            applyTheme();
            togglePerfMode(state.perfMode);
            renderCategories();
            renderLibrary();
            initMobileControls();
            
            // Populate settings
            document.getElementById('perf-toggle').checked = state.perfMode;
            document.getElementById('panic-url').value = state.panic.url;
            document.getElementById('panic-title').value = state.panic.title;
            
            // Set initial icon preview
            updateIconPreview(state.panic.icon);

            populateGameSelector();

            // Focus listener
            document.getElementById('game-view').addEventListener('click', (e) => {
                if(state.activeGameId && e.target.id === 'game-view') {
                    document.getElementById('refocus-button').classList.remove('hidden');
                }
            });
            
            // Ensure favicon is correct on load
            if (state.isCloaked) toggleCloak();
        });

        // --- CORE FUNCTIONS ---

        function renderCategories() {
            const tags = [...new Set(gamesDB.map(g => g.tag))].sort();
            const container = document.getElementById('category-filters');
            container.innerHTML = `<button onclick="filterByTag('all', this)" class="filter-pill active">All</button>`;
            tags.forEach(tag => {
                container.innerHTML += `<button onclick="filterByTag('${tag}', this)" class="filter-pill">${tag}</button>`;
            });
        }

        function filterByTag(tag, btn) {
            document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderLibrary('', tag === 'all' ? null : tag);
        }

        function renderLibrary(search = '', tagFilter = null) {
            const grid = document.getElementById('games-grid');
            const favGrid = document.getElementById('favorites-grid');
            const recentGrid = document.getElementById('recent-grid');
            
            grid.innerHTML = ''; favGrid.innerHTML = ''; recentGrid.innerHTML = '';

            // Recent Games
            if (!search && !tagFilter && state.recent.length > 0) {
                state.recent.slice(0,6).forEach(id => {
                    const g = gamesDB.find(x => x.id === id);
                    if(g) recentGrid.innerHTML += createCardHTML(g, false);
                });
                document.getElementById('recent-section').classList.remove('hidden');
            } else {
                document.getElementById('recent-section').classList.add('hidden');
            }

            let count = 0;
            const term = search.toLowerCase();

            gamesDB.forEach(game => {
                if ((!tagFilter || game.tag === tagFilter) && game.title.toLowerCase().includes(term)) {
                    count++;
                    const card = createCardHTML(game, state.favs.includes(game.id));
                    grid.innerHTML += card;
                    if(state.favs.includes(game.id)) favGrid.innerHTML += card;
                }
            });

            document.getElementById('game-count').innerText = `${count} Games`;
            document.getElementById('favorites-section').classList.toggle('hidden', favGrid.innerHTML === '');
        }

        function createCardHTML(game, isFav) {
            // Uses game-card-rounded for the 2xl corners and game-card-text for the darker text color
            return `
                <div class="glass-panel relative game-card-rounded overflow-hidden aspect-[4/3] group cursor-pointer select-none" onclick="launchGame('${game.id}')">
                    <img src="${game.img}" loading="lazy" class="w-full h-full object-cover transition duration-500 group-hover:scale-110 group-hover:opacity-60">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent p-4 flex flex-col justify-end">
                        <h3 class="game-card-text font-bold leading-tight truncate">${game.title}</h3>
                        <p class="text-xs game-card-text-accent font-semibold uppercase tracking-wider mt-1">${game.tag}</p>
                    </div>
                    <button onclick="toggleFav(event, '${game.id}')" class="absolute top-2 right-2 p-2 rounded-full backdrop-blur-md game-card-button hover:bg-black/70 transition ${isFav ? 'text-panic' : 'text-gray-300'}">
                        <i class="${isFav ? 'ph-fill' : 'ph'} ph-heart text-lg"></i>
                    </button>
                </div>
            `;
        }

        // --- LAUNCHER LOGIC ---

        window.launchGame = function(id) {
            const game = gamesDB.find(g => g.id === id);
            if(!game) return;

            state.activeGameId = id;
            
            // Add to Recent
            state.recent = state.recent.filter(x => x !== id);
            state.recent.unshift(id);
            if(state.recent.length > 6) state.recent.pop();
            localStorage.setItem('arcade_recent', JSON.stringify(state.recent));

            // Setup UI
            document.getElementById('grid-view').classList.add('hidden');
            const gameView = document.getElementById('game-view');
            gameView.classList.remove('hidden');
            document.getElementById('current-game-title').innerText = game.title;
            
            // Start Timer
            let sec = 0;
            clearInterval(state.timerInterval);
            document.getElementById('session-timer').innerText = '00:00';
            state.timerInterval = setInterval(() => {
                sec++;
                document.getElementById('session-timer').innerText = 
                    `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
            }, 1000);

            // Load Iframe with Overrides
            const override = state.overrides[id] || {};
            const wrapper = document.getElementById('iframe-wrapper');
            wrapper.innerHTML = '';
            
            const iframe = document.createElement('iframe');
            iframe.src = override.url || game.url;
            iframe.className = "w-full h-full border-none opacity-0 transition-opacity duration-500";
            iframe.allow = "autoplay; fullscreen; gamepad; focus-without-user-activation *";
            
            let perms = new Set(DEFAULT_SANDBOX);
            if(override.sandbox) override.sandbox.forEach(p => perms.add(p));
            iframe.sandbox = Array.from(perms).join(' ');

            iframe.onload = () => { iframe.classList.remove('opacity-0'); iframe.focus(); };
            wrapper.appendChild(iframe);
        }

        window.goHome = function() {
            document.getElementById('iframe-wrapper').innerHTML = '';
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('grid-view').classList.remove('hidden');
            document.getElementById('mobile-controls').classList.add('hidden');
            clearInterval(state.timerInterval);
            state.activeGameId = null;
            if(document.fullscreenElement) document.exitFullscreen();
            renderLibrary();
        }

        window.refreshGame = () => {
             const iframe = document.querySelector('#iframe-wrapper iframe');
             if(iframe) iframe.src = iframe.src;
             notify('Frame Reloaded', 'success');
        }

        window.restartGame = () => {
             if(state.activeGameId) launchGame(state.activeGameId);
             notify('Session Restarted', 'warn');
        }

        // --- SETTINGS & UTILS ---

        function applyTheme() {
            document.body.setAttribute('data-theme', state.theme);
        }
        
        window.toggleTheme = () => {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('arcade_theme', state.theme);
            applyTheme();
        }

        window.togglePerfMode = (active) => {
            state.perfMode = active;
            localStorage.setItem('arcade_perf', active);
            if(active) document.body.classList.add('perf-mode');
            else document.body.classList.remove('perf-mode');
        }

        window.openSettings = () => { 
            document.getElementById('settings-modal').classList.remove('hidden'); 
            switchSettingsTab('general');
            updateIconPreview(state.panic.icon); // Update preview when opening
        }
        window.closeSettings = (e) => { if(!e || e.target.id === 'settings-modal') document.getElementById('settings-modal').classList.add('hidden'); }
        
        window.switchSettingsTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('active');
            // Show/Hide tabs
            document.getElementById('tab-general').classList.add('hidden');
            document.getElementById('tab-cloak').classList.add('hidden');
            document.getElementById('tab-game-specific').classList.add('hidden');
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
        }

        window.saveSettings = () => {
            state.panic.url = document.getElementById('panic-url').value;
            state.panic.title = document.getElementById('panic-title').value;
            // The icon data is updated via the previewIcon function
            
            localStorage.setItem('arcade_panic', JSON.stringify(state.panic));
            
            // Re-apply cloak settings if currently cloaked
            if(state.isCloaked) {
                toggleCloak(); // Off
                toggleCloak(); // On with new settings
            }

            closeSettings();
            notify('Settings Saved', 'success');
        }

        window.toggleFav = (e, id) => {
            e.stopPropagation();
            if(state.favs.includes(id)) state.favs = state.favs.filter(x=>x!==id);
            else state.favs.push(id);
            localStorage.setItem('arcade_favs', JSON.stringify(state.favs));
            renderLibrary();
            notify(state.favs.includes(id) ? 'Added to Favorites' : 'Removed from Favorites', 'success');

        }

        // --- FAVICON/CLOAK LOGIC ---
        
        window.previewIcon = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 1024 * 1024) { // 1MB limit
                notify("Image too large (max 1MB)", 'panic');
                event.target.value = null;
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64Icon = e.target.result;
                state.panic.icon = base64Icon; // Update state directly
                updateIconPreview(base64Icon);
            };
            reader.readAsDataURL(file);
        }

        window.resetIcon = () => {
            state.panic.icon = ""; // Reset to default (which will be CLOAK_ICON_URL or HTML default)
            document.getElementById('panic-icon-file').value = null;
            updateIconPreview(state.panic.icon);
        }
        
        function updateIconPreview(url) {
            const preview = document.getElementById('panic-icon-preview');
            const iconToDisplay = url || CLOAK_ICON_URL;
            preview.style.backgroundImage = `url('${iconToDisplay}')`;
        }
        
        window.changeFavicon = (src) => {
            let link = document.querySelector("link[rel~='icon']");
            if (!link) {
                link = document.createElement('link');
                link.rel = 'icon';
                document.head.appendChild(link);
            }
            link.href = src;
        }

        window.toggleCloak = () => {
            state.isCloaked = !state.isCloaked;
            const btn = document.getElementById('mode-toggle-btn');
            
            if (state.isCloaked) {
                document.title = state.panic.title;
                const iconSrc = state.panic.icon || CLOAK_ICON_URL;
                changeFavicon(iconSrc);
                btn.classList.add('bg-accent', 'text-white');
                document.getElementById('mode-text').innerText = "Uncloak";
                notify('Cloak Active: Tab Hidden', 'warn');
            } else {
                document.title = "ANWARSARCADE";
                changeFavicon(DEFAULT_ICON);
                btn.classList.remove('bg-accent', 'text-white');
                document.getElementById('mode-text').innerText = "Cloak";
            }
        }


        // --- GAME OVERRIDES LOGIC ---
        function populateGameSelector() {
            const sel = document.getElementById('game-selector');
            gamesDB.forEach(g => sel.innerHTML += `<option value="${g.id}">${g.title}</option>`);
        }

        window.loadGameSettings = (id) => {
            const panel = document.getElementById('game-settings-panel');
            if(!id) { panel.classList.add('hidden'); return; }
            panel.classList.remove('hidden');
            
            const override = state.overrides[id] || {};
            const game = gamesDB.find(g => g.id === id);
            
            document.getElementById('override-url').value = override.url || game.url;
            const perms = override.sandbox || DEFAULT_SANDBOX;
            document.getElementById('sandbox-scripts').checked = perms.includes('allow-scripts');
            document.getElementById('sandbox-pointer').checked = perms.includes('allow-pointer-lock');
        }

        window.saveGameOverrides = () => {
            const id = document.getElementById('game-selector').value;
            if(!id) return;
            
            const perms = [];
            if(document.getElementById('sandbox-scripts').checked) perms.push('allow-scripts');
            if(document.getElementById('sandbox-pointer').checked) perms.push('allow-pointer-lock');
            perms.push('allow-same-origin', 'allow-forms'); // Always needed

            state.overrides[id] = {
                url: document.getElementById('override-url').value,
                sandbox: perms
            };
            localStorage.setItem('arcade_overrides', JSON.stringify(state.overrides));
            notify('Game Fixed & Saved', 'success');
        }

        window.fixGameControls = () => {
            document.getElementById('sandbox-scripts').checked = true;
            document.getElementById('sandbox-pointer').checked = true;
        }

        // --- HELPERS ---
        window.triggerPanic = () => window.location.href = state.panic.url;

        window.focusIframe = () => {
            const iframe = document.querySelector('iframe');
            if(iframe) { iframe.focus(); document.getElementById('refocus-button').classList.add('hidden'); }
        }
        
        window.toggleRefocusButton = () => {
            document.getElementById('refocus-button').classList.toggle('hidden');
        }

        window.toggleMobileControls = () => {
            document.getElementById('mobile-controls').classList.toggle('hidden');
        }

        function notify(msg, type) {
            const t = document.createElement('div');
            t.className = `px-4 py-3 rounded-2xl bg-gray-900 border-l-4 ${type==='success'?'border-success text-success':'border-accent text-accent'} shadow-2xl font-bold text-sm animate-fade-in`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(()=>t.remove(), 2500);
        }

        function initMobileControls() {
            document.querySelectorAll('.arcade-btn').forEach(btn => {
                btn.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    btn.classList.add('pressed');
                    sendKey(btn.dataset.key, 'keydown');
                });
                btn.addEventListener('pointerup', (e) => {
                    e.preventDefault();
                    btn.classList.remove('pressed');
                    sendKey(btn.dataset.key, 'keyup');
                });
            });
        }
        
        function sendKey(key, type) {
            const ev = new KeyboardEvent(type, { key: key, code: key, bubbles: true });
            document.dispatchEvent(ev);
            const iframe = document.querySelector('iframe');
            if(iframe && iframe.contentWindow) try { iframe.contentWindow.dispatchEvent(ev); } catch(e){}
        }

        window.clearLocalStorage = () => {
            if(confirm("Reset everything?")) { localStorage.clear(); location.reload(); }
        }
        
        window.filterGames = (val) => renderLibrary(val);
        window.toggleTrueFullscreen = () => {
            if(!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }
    </script>
</body>
</html>
